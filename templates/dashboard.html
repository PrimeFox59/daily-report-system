{% extends 'base.html' %}
{% block title %}Dashboard - Daily Report System{% endblock %}
{% block content %}
<div class="row mb-4">
  <div class="col">
    <h1 class="display-6"><i class="bi bi-speedometer2"></i> Dashboard</h1>
    <p class="text-muted">Welcome back, <strong>{{ current_user.name }}</strong> (ID: {{ current_user.employee_id }})</p>
  </div>
</div>

<div class="row">
  <!-- Left Column: Calendar & Stats -->
  <div class="col-lg-7">
    <div class="row mb-4">
      <!-- Calendar Card -->
      <div class="col-md-5">
        <div class="card shadow h-100">
          <div class="card-header bg-white d-flex justify-content-between align-items-center py-2">
            <h6 class="mb-0"><i class="bi bi-calendar3"></i> Report Calendar</h6>
            <button class="btn btn-sm btn-outline-secondary" id="today-btn">Today</button>
          </div>
          <div class="card-body p-2">
            <div id="calendar-container">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <button class="btn btn-sm btn-outline-primary" id="prev-month">
                  <i class="bi bi-chevron-left"></i>
                </button>
                <h6 class="mb-0 small" id="calendar-month-year"></h6>
                <button class="btn btn-sm btn-outline-primary" id="next-month">
                  <i class="bi bi-chevron-right"></i>
                </button>
              </div>
              <div id="calendar-grid"></div>
              <div class="mt-2 small text-muted text-center" style="font-size: 0.7rem;">
                <span class="badge bg-success" style="font-size: 0.6rem;">●</span> Has reports
                <span class="ms-2 badge bg-secondary" style="font-size: 0.6rem;">●</span> Selected
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="col-md-7">
        <div class="row g-3">
          <div class="col-6">
            <div class="card text-white bg-primary h-100">
              <div class="card-body p-3">
                <h6 class="card-title small"><i class="bi bi-file-text"></i> Total Reports</h6>
                <h2 class="mb-0" id="total-count">{{ reports|length }}</h2>
              </div>
            </div>
          </div>
          {% for category in categories %}
          <div class="col-6">
            {% set is_hex_color = category.color and category.color.startswith('#') %}
            {% set card_bg_class = '' if is_hex_color else 'bg-' ~ category.color %}
            <div class="card text-white h-100 {{ card_bg_class }}"{% if is_hex_color %} data-hex-color="{{ category.color }}"{% endif %}>
              <div class="card-body p-3">
                <h6 class="card-title small"><i class="{{ category.icon }}"></i> {{ category.name }}</h6>
                <h2 class="mb-0" id="{{ category.name.lower() }}-count">{{ category_counts[category.name] }}</h2>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Recent Reports -->
    <div class="card shadow">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-journal-text"></i> Recent Reports</h5>
        <small class="text-muted" id="filter-date-display"></small>
      </div>
      <div class="card-body">
        <div id="reports-list">
          {% if reports %}
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Category</th>
                    <th>Title</th>
                    <th>Details</th>
                    <th style="width: 100px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="reports-tbody">
                  {% for r in reports %}
                  {% set days_old = (now - r.created_at).days if now else 0 %}
                  {% set cat = categories|selectattr('name', 'equalto', r.category)|first %}
                  {% set cat_color = cat.color if cat else 'secondary' %}
                  {% set is_hex = cat_color.startswith('#') if cat_color else false %}
                  <tr data-report-id="{{ r.id }}">
                    <td><span class="badge bg-secondary">{{ r.time }}</span></td>
                    <td>
                      {% if is_hex %}
                        <span class="badge text-white" style="background-color: {{ cat_color }};">{{ r.category }}</span>
                      {% else %}
                        <span class="badge bg-{{ cat_color }}">{{ r.category }}</span>
                      {% endif %}
                    </td>
                    <td><strong>{{ r.title }}</strong></td>
                    <td>
                      <small class="text-muted">{{ r.notes[:50] }}{% if r.notes|length > 50 %}...{% endif %}</small>
                      {% if r.item_name or r.part_number or r.customer %}
                        <br><small>
                          {% if r.item_name %}<i class="bi bi-box"></i> {{ r.item_name }}{% endif %}
                          {% if r.part_number %}<i class="bi bi-upc"></i> {{ r.part_number }}{% endif %}
                          {% if r.customer %}<i class="bi bi-person"></i> {{ r.customer }}{% endif %}
                        </small>
                      {% endif %}
                    </td>
                    <td>
                      {% if days_old < 2 %}
                        <button class="btn btn-sm btn-outline-primary edit-btn" data-id="{{ r.id }}" data-time="{{ r.time }}" data-category="{{ r.category }}" data-title="{{ r.title }}" data-notes="{{ r.notes or '' }}" data-item="{{ r.item_name or '' }}" data-part="{{ r.part_number or '' }}" data-customer="{{ r.customer or '' }}" title="Edit">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-btn" data-id="{{ r.id }}" title="Delete">
                          <i class="bi bi-trash"></i>
                        </button>
                      {% else %}
                        <small class="text-muted">Locked</small>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-5">
              <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
              <p class="text-muted mt-3">No reports yet. Start by creating your first report!</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Right Column: New Report Form -->
  <div class="col-lg-5">
    <div class="row">
      <!-- New Report Form -->
      <div class="col-md-7">
        <div class="card shadow sticky-top" style="top: 20px;" id="report-form-card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> New Report</h5>
      </div>
      <div class="card-body" id="drop-zone">
        <div id="form-alerts"></div>
        <form id="report-form">
          {{ form.hidden_tag() }}
          
          <div class="mb-3">
            <label class="form-label">Time</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-clock"></i></span>
              <input type="text" class="form-control" name="time" placeholder="07:00" required>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select" name="category" required>
              {% for category in categories %}
              <option value="{{ category.name }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" name="title" placeholder="Brief description" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" name="notes" rows="3" placeholder="Detailed notes..."></textarea>
          </div>

          <hr>
          <h6 class="text-muted mb-2">
            <i class="bi bi-info-circle"></i> Optional Details
            <small class="text-muted">(Auto-saved for next reports)</small>
          </h6>

          <div class="mb-3">
            <label class="form-label">
              Item Name
              <small class="text-muted"><i class="bi bi-lightbulb"></i> Autocomplete shows: Item | Part# | Customer</small>
            </label>
            <input type="text" class="form-control" name="item_name" id="item_name" placeholder="Type to search items..." value="{{ last_report.item_name or '' }}" list="item-name-suggestions" autocomplete="off">
            <datalist id="item-name-suggestions"></datalist>
          </div>

          <div class="mb-3">
            <label class="form-label">Part Number</label>
            <input type="text" class="form-control" name="part_number" id="part_number" placeholder="Part number" value="{{ last_report.part_number or '' }}">
          </div>

          <div class="mb-3">
            <label class="form-label">Customer</label>
            <input type="text" class="form-control" name="customer" id="customer" placeholder="Customer name" value="{{ last_report.customer or '' }}">
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-grow-1" id="submit-btn">
              <i class="bi bi-save"></i> Save Report
            </button>
            <button type="button" class="btn btn-outline-info" id="save-template-btn" title="Save as Template">
              <i class="bi bi-sticky"></i>
            </button>
          </div>
        </form>
      </div>
    </div>
      </div>
      
      <!-- Quick Templates Column -->
      <div class="col-md-5">
        <div class="card shadow sticky-top" style="top: 20px;">
          <div class="card-header bg-info text-white text-center">
            <h6 class="mb-0"><i class="bi bi-sticky"></i> Quick Templates</h6>
            <small style="font-size: 0.75rem;">Drag to form →</small>
          </div>
          <div class="card-body p-2" style="background: #f8f9fa; max-height: 600px; overflow-y: auto;">
            <div id="templates-container" class="d-flex flex-wrap gap-2" style="min-height: 80px;">
              {% if templates %}
                {% for template in templates %}
                <div class="sticky-note" 
                     draggable="true" 
                     data-id="{{ template.id }}"
                     data-category="{{ template.category }}"
                     data-title="{{ template.title }}"
                     data-notes="{{ template.notes or '' }}"
                     data-item="{{ template.item_name or '' }}"
                     data-part="{{ template.part_number or '' }}"
                     data-customer="{{ template.customer or '' }}"
                     data-color="{{ template.color }}">
                  <div class="sticky-note-header">
                    <small class="sticky-note-title">{{ template.name }}</small>
                    <button class="btn-delete-template" data-template-id="{{ template.id }}" title="Delete">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                  <div class="sticky-note-content">
                    <span class="badge bg-dark mb-1">{{ template.category }}</span>
                    <div class="small"><strong>{{ template.title[:25] }}{% if template.title|length > 25 %}...{% endif %}</strong></div>
                    {% if template.notes %}
                    <div class="text-muted" style="font-size: 0.7rem; line-height: 1.2; margin-top: 4px;">{{ template.notes[:50] }}{% if template.notes|length > 50 %}...{% endif %}</div>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              {% else %}
                <div class="text-center w-100 py-3 text-muted" id="no-templates">
                  <i class="bi bi-inbox"></i>
                  <p class="small mb-0">No templates yet</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Reports Data for Calendar (JSON) -->
<script id="reports-data" type="application/json">
{{ reports_json|tojson }}
</script>

<!-- Category Colors Map (JSON) -->
<script id="category-colors" type="application/json">
{{ category_colors|tojson }}
</script>

<!-- Save Template Modal -->
<div class="modal fade" id="saveTemplateModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h6 class="modal-title"><i class="bi bi-sticky"></i> Save as Template</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="template-alerts"></div>
        <div class="mb-3">
          <label class="form-label">Template Name</label>
          <input type="text" class="form-control" id="template-name" placeholder="e.g., Daily Check" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Color</label>
          <div class="d-flex gap-2">
            <input type="radio" class="btn-check" name="template-color" id="color-yellow" value="yellow" checked>
            <label class="btn btn-sm btn-outline-warning" for="color-yellow">Yellow</label>
            
            <input type="radio" class="btn-check" name="template-color" id="color-pink" value="pink">
            <label class="btn btn-sm btn-outline-danger" for="color-pink">Pink</label>
            
            <input type="radio" class="btn-check" name="template-color" id="color-blue" value="blue">
            <label class="btn btn-sm btn-outline-info" for="color-blue">Blue</label>
            
            <input type="radio" class="btn-check" name="template-color" id="color-green" value="green">
            <label class="btn btn-sm btn-outline-success" for="color-green">Green</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info btn-sm" id="confirm-save-template">
          <i class="bi bi-check"></i> Save Template
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Report Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="edit-alerts"></div>
        <form id="edit-form">
          <input type="hidden" id="edit-report-id">
          <div class="mb-3">
            <label class="form-label">Time</label>
            <input type="text" class="form-control" id="edit-time" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select" id="edit-category" required>
              {% for category in categories %}
              <option value="{{ category.name }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Title</label>
            <input type="text" class="form-control" id="edit-title" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea class="form-control" id="edit-notes" rows="3"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Item Name</label>
            <input type="text" class="form-control" id="edit-item">
          </div>
          <div class="mb-3">
            <label class="form-label">Part Number</label>
            <input type="text" class="form-control" id="edit-part">
          </div>
          <div class="mb-3">
            <label class="form-label">Customer</label>
            <input type="text" class="form-control" id="edit-customer">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-edit-btn"><i class="bi bi-save"></i> Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Report Detail Modal -->
<div class="modal fade" id="reportDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-gradient text-white" id="detail-modal-header">
        <h5 class="modal-title"><i class="bi bi-file-text"></i> Report Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="detail-card">
              <label class="detail-label"><i class="bi bi-clock"></i> Time</label>
              <div class="detail-value" id="detail-time"></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="detail-card">
              <label class="detail-label"><i class="bi bi-tag"></i> Category</label>
              <div class="detail-value" id="detail-category"></div>
            </div>
          </div>
          <div class="col-12">
            <div class="detail-card">
              <label class="detail-label"><i class="bi bi-bookmark"></i> Title</label>
              <div class="detail-value" id="detail-title"></div>
            </div>
          </div>
          <div class="col-12">
            <div class="detail-card">
              <label class="detail-label"><i class="bi bi-card-text"></i> Notes</label>
              <div class="detail-value" id="detail-notes"></div>
            </div>
          </div>
          <div class="col-md-4" id="detail-item-container" style="display: none;">
            <div class="detail-card">
              <label class="detail-label"><i class="bi bi-box"></i> Item Name</label>
              <div class="detail-value" id="detail-item"></div>
            </div>
          </div>
          <div class="col-md-4" id="detail-part-container" style="display: none;">
            <div class="detail-card">
              <label class="detail-label"><i class="bi bi-upc"></i> Part Number</label>
              <div class="detail-value" id="detail-part"></div>
            </div>
          </div>
          <div class="col-md-4" id="detail-customer-container" style="display: none;">
            <div class="detail-card">
              <label class="detail-label"><i class="bi bi-person"></i> Customer</label>
              <div class="detail-value" id="detail-customer"></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="detail-card">
              <label class="detail-label"><i class="bi bi-person-badge"></i> Created By</label>
              <div class="detail-value" id="detail-creator"></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="detail-card">
              <label class="detail-label"><i class="bi bi-calendar-event"></i> Created At</label>
              <div class="detail-value" id="detail-created"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-outline-primary" id="detail-edit-btn" style="display: none;">
          <i class="bi bi-pencil"></i> Edit Report
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* Sticky Notes Styles */
.sticky-note {
  width: calc(25% - 6px);
  min-width: 140px;
  height: 110px;
  padding: 10px;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  cursor: move;
  position: relative;
  transition: all 0.2s;
  font-size: 0.8rem;
}

/* Report Detail Modal Styles */
.bg-gradient {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.detail-card {
  background: #f8f9fa;
  border-left: 3px solid #667eea;
  padding: 12px 16px;
  border-radius: 6px;
  min-height: 60px;
}

.detail-label {
  font-size: 0.75rem;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
  display: block;
}

.detail-value {
  font-size: 1rem;
  color: #212529;
  word-wrap: break-word;
  white-space: pre-wrap;
}

.detail-value:empty:after {
  content: '-';
  color: #adb5bd;
}

#reports-tbody tr {
  cursor: pointer;
  transition: background-color 0.2s;
}

#reports-tbody tr:hover {
  background-color: #f8f9fa;
}


.sticky-note[data-color="yellow"] {
  background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
  border-left: 3px solid #fbc02d;
}

.sticky-note[data-color="pink"] {
  background: linear-gradient(135deg, #f8bbd0 0%, #f48fb1 100%);
  border-left: 3px solid #e91e63;
}

.sticky-note[data-color="blue"] {
  background: linear-gradient(135deg, #b3e5fc 0%, #81d4fa 100%);
  border-left: 3px solid #039be5;
}

.sticky-note[data-color="green"] {
  background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
  border-left: 3px solid #43a047;
}

.sticky-note:hover {
  transform: scale(1.05) rotate(2deg);
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  z-index: 10;
}

.sticky-note.dragging {
  opacity: 0.5;
  transform: rotate(5deg);
}

.sticky-note-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 4px;
}

.sticky-note-title {
  font-weight: 600;
  font-size: 0.7rem;
  line-height: 1.2;
  flex: 1;
}

.btn-delete-template {
  background: rgba(0,0,0,0.1);
  border: none;
  border-radius: 50%;
  width: 18px;
  height: 18px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-delete-template:hover {
  background: rgba(220,53,69,0.8);
  color: white;
}

.sticky-note-content {
  font-size: 0.65rem;
}

#drop-zone {
  min-height: 200px;
  transition: all 0.3s;
}

#drop-zone.drag-over {
  background: rgba(13, 110, 253, 0.05);
  border: 2px dashed #0d6efd;
  border-radius: 8px;
}

/* Calendar Styles */
#calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

.calendar-day-header {
  text-align: center;
  font-weight: 600;
  font-size: 0.65rem;
  padding: 4px 2px;
  color: #6c757d;
  background: #f8f9fa;
  border-radius: 3px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  background: white;
  font-size: 0.75rem;
  padding: 2px;
}

.calendar-day:hover {
  background: #f8f9fa;
  transform: scale(1.05);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.calendar-day.other-month {
  color: #adb5bd;
  background: #f8f9fa;
}

.calendar-day.today {
  background: #e7f3ff;
  border-color: #0d6efd;
  font-weight: 600;
}

.calendar-day.selected {
  background: #6c757d;
  color: white;
  font-weight: 600;
}

.calendar-day.has-reports {
  background: #d1e7dd;
  border-color: #198754;
}

.calendar-day.has-reports.selected {
  background: #198754;
  color: white;
}

.calendar-day .day-number {
  font-size: 0.75rem;
}

.calendar-day .report-count {
  font-size: 0.55rem;
  color: #198754;
  font-weight: 600;
  margin-top: 1px;
}

.calendar-day.selected .report-count {
  color: white;
}
</style>

<script>
// Auto-fill current time (GMT+7)
function setCurrentTime() {
  const timeInput = document.querySelector('input[name="time"]');
  const now = new Date();
  // Convert to GMT+7 (WIB - Waktu Indonesia Barat)
  const offset = 7; // GMT+7
  const localTime = new Date(now.getTime() + (offset * 60 * 60 * 1000));
  const hours = String(localTime.getUTCHours()).padStart(2, '0');
  const minutes = String(localTime.getUTCMinutes()).padStart(2, '0');
  timeInput.value = `${hours}:${minutes}`;
}

// Set time on page load
document.addEventListener('DOMContentLoaded', function() {
  setCurrentTime();
  document.querySelectorAll('[data-hex-color]').forEach(card => {
    const color = card.dataset.hexColor;
    if (color) {
      card.style.backgroundColor = color;
    }
  });
});

// Save Template Handler
document.getElementById('save-template-btn').addEventListener('click', function() {
  const modal = new bootstrap.Modal(document.getElementById('saveTemplateModal'));
  modal.show();
});

document.getElementById('confirm-save-template').addEventListener('click', async function() {
  const templateName = document.getElementById('template-name').value;
  const color = document.querySelector('input[name="template-color"]:checked').value;
  
  if (!templateName) {
    document.getElementById('template-alerts').innerHTML = '<div class="alert alert-warning">Please enter a template name</div>';
    return;
  }
  
  const formData = new FormData();
  formData.append('name', templateName);
  formData.append('category', document.querySelector('[name="category"]').value);
  formData.append('title', document.querySelector('[name="title"]').value);
  formData.append('notes', document.querySelector('[name="notes"]').value);
  formData.append('item_name', document.querySelector('[name="item_name"]').value);
  formData.append('part_number', document.querySelector('[name="part_number"]').value);
  formData.append('customer', document.querySelector('[name="customer"]').value);
  formData.append('color', color);
  
  try {
    const response = await fetch('/template/create', {
      method: 'POST',
      body: formData
    });
    const result = await response.json();
    
    if (result.success) {
      // Add new sticky note
      const container = document.getElementById('templates-container');
      const noTemplates = document.getElementById('no-templates');
      if (noTemplates) noTemplates.remove();
      
      const template = result.template;
      const stickyNote = document.createElement('div');
      stickyNote.className = 'sticky-note';
      stickyNote.draggable = true;
      stickyNote.dataset.id = template.id;
      stickyNote.dataset.category = template.category;
      stickyNote.dataset.title = template.title;
      stickyNote.dataset.notes = template.notes || '';
      stickyNote.dataset.item = template.item_name || '';
      stickyNote.dataset.part = template.part_number || '';
      stickyNote.dataset.customer = template.customer || '';
      stickyNote.dataset.color = template.color;
      
      stickyNote.innerHTML = `
        <div class="sticky-note-header">
          <small class="sticky-note-title">${template.name}</small>
          <button class="btn-delete-template" data-template-id="${template.id}" title="Delete">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="sticky-note-content">
          <span class="badge bg-dark mb-1">${template.category}</span>
          <div class="small"><strong>${template.title.substring(0, 25)}${template.title.length > 25 ? '...' : ''}</strong></div>
          ${template.notes ? `<div class="text-muted" style="font-size: 0.7rem; line-height: 1.2; margin-top: 4px;">${template.notes.substring(0, 50)}${template.notes.length > 50 ? '...' : ''}</div>` : ''}
        </div>
      `;
      
      container.appendChild(stickyNote);
      setupDragAndDrop();
      
      // Close modal and reset
      bootstrap.Modal.getInstance(document.getElementById('saveTemplateModal')).hide();
      document.getElementById('template-name').value = '';
      document.getElementById('color-yellow').checked = true;
      
      // Show success message
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show';
      alertDiv.innerHTML = '<i class="bi bi-check-circle"></i> Template saved successfully!<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
      document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
      setTimeout(() => alertDiv.remove(), 3000);
    } else {
      document.getElementById('template-alerts').innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
    }
  } catch (error) {
    document.getElementById('template-alerts').innerHTML = '<div class="alert alert-danger">Error creating template</div>';
  }
});

// Delete Template with event delegation
document.addEventListener('click', async function(e) {
  if (e.target.closest('.btn-delete-template')) {
    const btn = e.target.closest('.btn-delete-template');
    const templateId = btn.dataset.templateId;
    
    if (!confirm('Delete this template?')) return;
    
    try {
      const response = await fetch(`/template/${templateId}/delete`, { method: 'POST' });
      const result = await response.json();
      
      if (result.success) {
        document.querySelector(`[data-id="${templateId}"]`).remove();
        
        // Show no templates message if empty
        const container = document.getElementById('templates-container');
        if (container.children.length === 0) {
          container.innerHTML = `
            <div class="text-center w-100 py-3 text-muted" id="no-templates">
              <i class="bi bi-inbox"></i>
              <p class="small mb-0">No templates yet. Save a report as template!</p>
            </div>
          `;
        }
      }
    } catch (error) {
      alert('Error deleting template');
    }
  }
});

// Drag and Drop Functionality
function setupDragAndDrop() {
  const dropZone = document.getElementById('drop-zone');
  const stickyNotes = document.querySelectorAll('.sticky-note');
  
  stickyNotes.forEach(note => {
    note.addEventListener('dragstart', function(e) {
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'copy';
      e.dataTransfer.setData('template', JSON.stringify({
        category: this.dataset.category,
        title: this.dataset.title,
        notes: this.dataset.notes,
        item_name: this.dataset.item,
        part_number: this.dataset.part,
        customer: this.dataset.customer
      }));
    });
    
    note.addEventListener('dragend', function() {
      this.classList.remove('dragging');
    });
  });
  
  dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('drag-over');
  });
  
  dropZone.addEventListener('dragleave', function() {
    this.classList.remove('drag-over');
  });
  
  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('drag-over');
    
    const data = JSON.parse(e.dataTransfer.getData('template'));
    
    // Fill form with template data
    document.querySelector('[name="category"]').value = data.category;
    document.querySelector('[name="title"]').value = data.title;
    document.querySelector('[name="notes"]').value = data.notes;
    document.querySelector('[name="item_name"]').value = data.item_name;
    document.querySelector('[name="part_number"]').value = data.part_number;
    document.querySelector('[name="customer"]').value = data.customer;
    
    // Show success feedback
    const alertsDiv = document.getElementById('form-alerts');
    alertsDiv.innerHTML = '<div class="alert alert-info alert-dismissible fade show"><i class="bi bi-check2-circle"></i> Template loaded! Add time and save.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
    setTimeout(() => alertsDiv.innerHTML = '', 3000);
    
    // Focus on time field
    document.querySelector('[name="time"]').focus();
  });
}

// Initialize on page load
setupDragAndDrop();

// --- Item suggestion & autofill ---
const itemInput = document.getElementById('item_name');
const partInput = document.getElementById('part_number');
const customerInput = document.getElementById('customer');
const itemDatalist = document.getElementById('item-name-suggestions');
let itemSuggestions = [];
let itemFetchTimer = null;

function applyItemAutofill(displayValue) {
  if (!displayValue) return;
  
  // Find exact match by display value (includes part number and customer)
  const match = itemSuggestions.find(s => s.display === displayValue.trim());
  
  if (match) {
    // Set all fields from matched item
    itemInput.value = match.item_name;
    partInput.value = match.part_number || '';
    customerInput.value = match.customer || '';
  }
}

async function fetchItemSuggestions(term) {
  try {
    const resp = await fetch(`/api/items/search?q=${encodeURIComponent(term)}`);
    if (!resp.ok) return;
    itemSuggestions = await resp.json();
    itemDatalist.innerHTML = '';
    
    // Create options with full display (item | part | customer)
    itemSuggestions.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.display; // Use display as value for selection
      opt.setAttribute('data-item-name', s.item_name);
      opt.setAttribute('data-part-number', s.part_number);
      opt.setAttribute('data-customer', s.customer);
      itemDatalist.appendChild(opt);
    });
  } catch (err) {
    console.error('Failed to load item suggestions', err);
  }
}

itemInput.addEventListener('input', () => {
  const term = itemInput.value.trim();
  if (itemFetchTimer) clearTimeout(itemFetchTimer);
  if (!term) {
    itemSuggestions = [];
    itemDatalist.innerHTML = '';
    return;
  }
  itemFetchTimer = setTimeout(() => fetchItemSuggestions(term), 200);
});

itemInput.addEventListener('change', () => {
  // Check if user selected from datalist (value will be in "item | part | customer" format)
  const inputValue = itemInput.value.trim();
  
  if (inputValue.includes('|')) {
    // User selected from dropdown - apply autofill
    applyItemAutofill(inputValue);
  } else {
    // User typed manually - try to find exact item name match
    const match = itemSuggestions.find(s => s.item_name.toLowerCase() === inputValue.toLowerCase());
    if (match) {
      // If only one match for this item name, auto-fill
      const sameNameItems = itemSuggestions.filter(s => s.item_name.toLowerCase() === inputValue.toLowerCase());
      if (sameNameItems.length === 1) {
        partInput.value = match.part_number || '';
        customerInput.value = match.customer || '';
      }
      // If multiple matches, leave part/customer empty for user to select manually
    }
  }
});


document.getElementById('report-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const submitBtn = document.getElementById('submit-btn');
  const alertsDiv = document.getElementById('form-alerts');
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
  
  try {
    const response = await fetch('{{ url_for("new_report") }}', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Show success alert
      alertsDiv.innerHTML = '<div class="alert alert-success alert-dismissible fade show"><i class="bi bi-check-circle"></i> Report saved successfully!<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
      
      // Reset only required fields (time, category, title, notes)
      // Keep optional details (item_name, part_number, customer) for next report
      setCurrentTime(); // Reset time to current GMT+7 time
      document.querySelector('[name="title"]').value = '';
      document.querySelector('[name="notes"]').value = '';
      
      // Update counts
      document.getElementById('total-count').textContent = parseInt(document.getElementById('total-count').textContent) + 1;
      const categoryCountId = result.category.toLowerCase() + '-count';
      const countElem = document.getElementById(categoryCountId);
      if (countElem) {
        countElem.textContent = parseInt(countElem.textContent) + 1;
      }
      
      // Add new row to table
      const tbody = document.getElementById('reports-tbody');
      if (tbody) {
        // Get category color from category-colors JSON
        const categoryColors = JSON.parse(document.getElementById('category-colors').textContent);
        const categoryColorRaw = categoryColors ? categoryColors[result.category] : null;
        const categoryColor = (typeof categoryColorRaw === 'string' && categoryColorRaw.trim() !== '') ? categoryColorRaw : 'secondary';
        const isHexColor = categoryColor.startsWith('#');
        
        // Get current report ID from response (you'll need to add this to backend)
        const reportId = result.report_id || Date.now();
        
        // Build optional details HTML
        let optionalDetails = '';
        if (result.item_name || result.part_number || result.customer) {
          optionalDetails = '<br><small>';
          if (result.item_name) optionalDetails += `<i class="bi bi-box"></i> ${result.item_name} `;
          if (result.part_number) optionalDetails += `<i class="bi bi-upc"></i> ${result.part_number} `;
          if (result.customer) optionalDetails += `<i class="bi bi-person"></i> ${result.customer}`;
          optionalDetails += '</small>';
        }
        
        // Create badge HTML based on color type
        const categoryBadge = isHexColor 
          ? `<span class="badge text-white" style="background-color: ${categoryColor};">${result.category}</span>`
          : `<span class="badge bg-${categoryColor}">${result.category}</span>`;
        
        const newRow = document.createElement('tr');
        newRow.setAttribute('data-report-id', reportId);
        newRow.className = 'table-success';
        newRow.innerHTML = `
          <td><span class="badge bg-secondary">${result.time}</span></td>
          <td>${categoryBadge}</td>
          <td><strong>${result.title}</strong></td>
          <td>
            <small class="text-muted">${result.notes ? (result.notes.substring(0, 50) + (result.notes.length > 50 ? '...' : '')) : ''}</small>
            ${optionalDetails}
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary edit-btn" 
                    data-id="${reportId}" 
                    data-time="${result.time}" 
                    data-category="${result.category}" 
                    data-title="${result.title}" 
                    data-notes="${result.notes || ''}" 
                    data-item="${result.item_name || ''}" 
                    data-part="${result.part_number || ''}" 
                    data-customer="${result.customer || ''}" 
                    title="Edit">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${reportId}" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.insertBefore(newRow, tbody.firstChild);
        
        // Add new report to allReports array for calendar
        const today = new Date();
        const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        allReports.push({
          id: reportId,
          created_at: `${dateStr} ${result.time}:00`,
          category: result.category,
          title: result.title
        });
        
        // Re-render calendar to show updated report count
        renderCalendar();
        
        // Remove highlight after 2 seconds
        setTimeout(() => {
          newRow.classList.remove('table-success');
        }, 2000);
      }
      
      // Auto-dismiss alert after 3 seconds
      setTimeout(() => {
        alertsDiv.innerHTML = '';
      }, 3000);
    } else {
      alertsDiv.innerHTML = '<div class="alert alert-danger alert-dismissible fade show">' + result.message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
    }
  } catch (error) {
    alertsDiv.innerHTML = '<div class="alert alert-danger alert-dismissible fade show">Error saving report. Please try again.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
  }
  
  submitBtn.disabled = false;
  submitBtn.innerHTML = '<i class="bi bi-save"></i> Save Report';
});

// Edit button handler
document.addEventListener('click', function(e) {
  if (e.target.closest('.edit-btn')) {
    const btn = e.target.closest('.edit-btn');
    document.getElementById('edit-report-id').value = btn.dataset.id;
    document.getElementById('edit-time').value = btn.dataset.time;
    document.getElementById('edit-category').value = btn.dataset.category;
    document.getElementById('edit-title').value = btn.dataset.title;
    document.getElementById('edit-notes').value = btn.dataset.notes;
    document.getElementById('edit-item').value = btn.dataset.item;
    document.getElementById('edit-part').value = btn.dataset.part;
    document.getElementById('edit-customer').value = btn.dataset.customer;
    
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
  }
});

// Report row click handler - Show detail modal
document.getElementById('reports-tbody').addEventListener('click', async function(e) {
  const row = e.target.closest('tr');
  if (!row || e.target.closest('.edit-btn') || e.target.closest('.delete-btn')) return;
  
  const reportId = row.dataset.reportId;
  if (!reportId) return;
  
  try {
    const response = await fetch(`/api/report/${reportId}`);
    const data = await response.json();
    
    if (data.success) {
      const report = data.report;
      
      // Set header gradient color based on category
      const headerEl = document.getElementById('detail-modal-header');
      const categoryColors = {
        'Quality': 'linear-gradient(135deg, #28a745 0%, #20c997 100%)',
        'Cost': 'linear-gradient(135deg, #ffc107 0%, #fd7e14 100%)',
        'Delivery': 'linear-gradient(135deg, #dc3545 0%, #e83e8c 100%)',
        'Safety': 'linear-gradient(135deg, #17a2b8 0%, #007bff 100%)',
        'Development': 'linear-gradient(135deg, #17a2b8 0%, #007bff 100%)',
        'Productivity': 'linear-gradient(135deg, #17a2b8 0%, #007bff 100%)'
      };
      headerEl.style.background = categoryColors[report.category] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      
      // Populate modal fields
      document.getElementById('detail-time').textContent = report.time;
      document.getElementById('detail-category').innerHTML = `<span class="badge bg-secondary">${report.category}</span>`;
      document.getElementById('detail-title').textContent = report.title;
      document.getElementById('detail-notes').textContent = report.notes || '-';
      document.getElementById('detail-creator').textContent = `${report.user_name} (${report.user_employee_id})`;
      document.getElementById('detail-created').textContent = report.created_at;
      
      // Optional fields - show/hide containers
      const itemContainer = document.getElementById('detail-item-container');
      const partContainer = document.getElementById('detail-part-container');
      const customerContainer = document.getElementById('detail-customer-container');
      
      if (report.item_name) {
        document.getElementById('detail-item').textContent = report.item_name;
        itemContainer.style.display = 'block';
      } else {
        itemContainer.style.display = 'none';
      }
      
      if (report.part_number) {
        document.getElementById('detail-part').textContent = report.part_number;
        partContainer.style.display = 'block';
      } else {
        partContainer.style.display = 'none';
      }
      
      if (report.customer) {
        document.getElementById('detail-customer').textContent = report.customer;
        customerContainer.style.display = 'block';
      } else {
        customerContainer.style.display = 'none';
      }
      
      // Show edit button if report is editable (less than 2 days old)
      const editBtn = document.getElementById('detail-edit-btn');
      if (report.is_editable) {
        editBtn.style.display = 'inline-block';
        editBtn.onclick = function() {
          bootstrap.Modal.getInstance(document.getElementById('reportDetailModal')).hide();
          // Trigger edit modal
          const editEvent = new Event('click', { bubbles: true });
          const editBtnInTable = document.querySelector(`.edit-btn[data-id="${reportId}"]`);
          if (editBtnInTable) {
            editBtnInTable.dispatchEvent(editEvent);
          }
        };
      } else {
        editBtn.style.display = 'none';
      }
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('reportDetailModal'));
      modal.show();
    }
  } catch (error) {
    console.error('Error fetching report details:', error);
  }
});

// Save edit handler
document.getElementById('save-edit-btn').addEventListener('click', async function() {
  const reportId = document.getElementById('edit-report-id').value;
  const formData = new FormData();
  formData.append('time', document.getElementById('edit-time').value);
  formData.append('category', document.getElementById('edit-category').value);
  formData.append('title', document.getElementById('edit-title').value);
  formData.append('notes', document.getElementById('edit-notes').value);
  formData.append('item_name', document.getElementById('edit-item').value);
  formData.append('part_number', document.getElementById('edit-part').value);
  formData.append('customer', document.getElementById('edit-customer').value);
  
  try {
    const response = await fetch(`/report/edit/${reportId}`, {
      method: 'POST',
      body: formData
    });
    const result = await response.json();
    
    if (result.success) {
      bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
      location.reload(); // Refresh to show updated data
    } else {
      document.getElementById('edit-alerts').innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
    }
  } catch (error) {
    document.getElementById('edit-alerts').innerHTML = '<div class="alert alert-danger">Error updating report</div>';
  }
});

// Delete button handler
document.addEventListener('click', async function(e) {
  if (e.target.closest('.delete-btn')) {
    if (!confirm('Are you sure you want to delete this report?')) return;
    
    const btn = e.target.closest('.delete-btn');
    const reportId = btn.dataset.id;
    
    try {
      const response = await fetch(`/report/delete/${reportId}`, {
        method: 'POST'
      });
      const result = await response.json();
      
      if (result.success) {
        // Remove row from table
        const row = document.querySelector(`tr[data-report-id="${reportId}"]`);
        if (row) row.remove();
        
        // Remove from allReports array
        const reportIndex = allReports.findIndex(r => r.id == reportId);
        if (reportIndex !== -1) {
          allReports.splice(reportIndex, 1);
          // Re-render calendar to update report count
          renderCalendar();
        }
        
        // Update counts
        const totalCount = document.getElementById('total-count');
        totalCount.textContent = parseInt(totalCount.textContent) - 1;
        
        const categoryCountId = result.category.toLowerCase() + '-count';
        const countElem = document.getElementById(categoryCountId);
        if (countElem) {
          countElem.textContent = parseInt(countElem.textContent) - 1;
        }
        
        // Show success message
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = '<i class="bi bi-check-circle"></i> Report deleted successfully<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
        
        setTimeout(() => alertDiv.remove(), 3000);
      } else {
        alert(result.message);
      }
    } catch (error) {
      alert('Error deleting report');
    }
  }
});

// Calendar functionality
let currentDate = new Date();
let selectedDate = null;
// Load reports data from JSON script tag
let allReports = JSON.parse(document.getElementById('reports-data').textContent);

function renderCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  // Update month/year display
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
  document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;
  
  // Get first day of month and number of days
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const daysInPrevMonth = new Date(year, month, 0).getDate();
  
  // Count reports by date
  const reportsByDate = {};
  allReports.forEach(report => {
    const date = report.created_at.split(' ')[0]; // Get date part only
    reportsByDate[date] = (reportsByDate[date] || 0) + 1;
  });
  
  // Create calendar grid
  let html = '';
  
  // Day headers
  const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  dayHeaders.forEach(day => {
    html += `<div class="calendar-day-header">${day}</div>`;
  });
  
  // Previous month days
  for (let i = firstDay - 1; i >= 0; i--) {
    const day = daysInPrevMonth - i;
    html += `<div class="calendar-day other-month"><span class="day-number">${day}</span></div>`;
  }
  
  // Current month days
  const today = new Date();
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const reportCount = reportsByDate[dateStr] || 0;
    const isToday = (year === today.getFullYear() && month === today.getMonth() && day === today.getDate());
    const isSelected = selectedDate === dateStr;
    
    let classes = 'calendar-day';
    if (isToday) classes += ' today';
    if (isSelected) classes += ' selected';
    if (reportCount > 0) classes += ' has-reports';
    
    html += `<div class="${classes}" data-date="${dateStr}">
              <span class="day-number">${day}</span>
              ${reportCount > 0 ? `<span class="report-count">${reportCount}</span>` : ''}
             </div>`;
  }
  
  // Next month days
  const remainingCells = 42 - (firstDay + daysInMonth); // 6 rows * 7 days
  for (let day = 1; day <= remainingCells; day++) {
    html += `<div class="calendar-day other-month"><span class="day-number">${day}</span></div>`;
  }
  
  document.getElementById('calendar-grid').innerHTML = html;
  
  // Add click handlers
  document.querySelectorAll('.calendar-day:not(.other-month)').forEach(dayElem => {
    dayElem.addEventListener('click', function() {
      const date = this.dataset.date;
      if (date) {
        selectedDate = selectedDate === date ? null : date;
        renderCalendar();
        filterReportsByDate();
      }
    });
  });
}

function filterReportsByDate() {
  const tbody = document.getElementById('reports-tbody');
  const filterDisplay = document.getElementById('filter-date-display');
  
  if (selectedDate) {
    // Format date for display
    const [year, month, day] = selectedDate.split('-');
    const dateObj = new Date(year, month - 1, day);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    filterDisplay.textContent = `Showing: ${dateObj.toLocaleDateString('en-US', options)}`;
    
    // Filter reports - hide/show existing rows
    const rows = document.querySelectorAll('#reports-tbody tr:not(.no-reports-row)');
    let visibleCount = 0;
    
    rows.forEach(row => {
      const reportDate = allReports.find(r => r.id == row.dataset.reportId)?.created_at.split(' ')[0];
      if (reportDate === selectedDate) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });
    
    // Show or hide "no reports" message
    let noReportsRow = tbody.querySelector('.no-reports-row');
    if (visibleCount === 0) {
      if (!noReportsRow) {
        noReportsRow = document.createElement('tr');
        noReportsRow.className = 'no-reports-row';
        noReportsRow.innerHTML = '<td colspan="5" class="text-center text-muted py-4"><i class="bi bi-inbox"></i> No reports for this date</td>';
        tbody.appendChild(noReportsRow);
      }
      noReportsRow.style.display = '';
    } else {
      if (noReportsRow) {
        noReportsRow.style.display = 'none';
      }
    }
  } else {
    filterDisplay.textContent = '';
    const rows = document.querySelectorAll('#reports-tbody tr:not(.no-reports-row)');
    rows.forEach(row => row.style.display = '');
    
    // Hide "no reports" message
    const noReportsRow = tbody.querySelector('.no-reports-row');
    if (noReportsRow) {
      noReportsRow.style.display = 'none';
    }
  }
}

// Calendar navigation
document.getElementById('prev-month').addEventListener('click', () => {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar();
});

document.getElementById('next-month').addEventListener('click', () => {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar();
});

document.getElementById('today-btn').addEventListener('click', () => {
  currentDate = new Date();
  selectedDate = null;
  renderCalendar();
  filterReportsByDate();
});

// Initialize calendar and set today as default selected date
const today = new Date();
selectedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
renderCalendar();
filterReportsByDate();
</script>
{% endblock %}
